<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>設問追加</title>
  <link rel="stylesheet" th:href="@{/css/common.css}">
</head>

<body>
  <div th:replace="fragments/admin-header :: header"></div>
  <div class="container">
    <h1 class="page-title">設問追加</h1>

    <div class="actions" style="margin-bottom:12px;">
      <a class="btn" th:href="@{|/admin/surveys/${surveyId}|}">アンケート詳細に戻る</a>
      <a class="btn" th:href="@{|/admin/surveys/${surveyId}/questions/import|}">CSVインポートへ</a>
    </div>

    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <form th:action="@{|/admin/surveys/${surveyId}/questions|}" th:object="${form}" method="post">

      <div class="card" style="margin-bottom: 12px;">
        <h2 class="section-title">【基本】</h2>

        <dl class="kv">
          <dt>設問文</dt>
          <dd>
            <textarea class="input" th:field="*{questionText}" rows="5"></textarea>
          </dd>

          <dt>設問タイプ</dt>
          <dd>
            <select class="input" th:field="*{questionType}">
              <option value="SINGLE_CHOICE">単一選択</option>
              <option value="MULTI_CHOICE">複数選択</option>
              <option value="TEXT">自由記述</option>
              <option value="NUMBER">数値</option>
            </select>
            <p class="muted">※まずは単一選択（5段階/7段階など）を想定</p>
          </dd>

          <dt>用途</dt>
          <dd>
            <select class="input" th:field="*{questionRole}">
              <option value="NORMAL">通常（尺度項目）</option>
              <option value="ATTENTION_CHECK">注意確認</option>
              <option value="VALIDITY_CHECK">妥当性確認</option>
            </select>
            <p class="muted">注意確認のみ「期待する回答」を設定できます</p>
          </dd>

          <dt>設定</dt>
          <dd>
            <label style="margin-right:12px;"><input type="checkbox" th:field="*{required}"> 必須</label>
            <label><input type="checkbox" th:field="*{reverse}"> 逆転項目</label>
          </dd>
        </dl>
      </div>

      <div class="card" style="margin-bottom: 12px;">
        <h2 class="section-title">【選択肢】</h2>

        <p class="muted" style="margin-top:0;">
          通常はスコア（集計用の点数）をテンプレで自動設定します。カスタムにする場合のみ手入力してください。
        </p>

        <div class="form-row" style="margin: 8px 0 12px;">
          <label class="muted">テンプレ</label>
          <select class="input" th:field="*{optionTemplate}">
            <option value="LIKERT5">5段階（1〜5）</option>
            <option value="LIKERT7">7段階（1〜7）</option>
            <option value="CUSTOM">カスタム（手入力）</option>
          </select>
        </div>

        <div class="scroll-box">
          <table class="table">
            <thead>
              <tr>
                <th class="nowrap">#</th>
                <th>選択肢テキスト</th>
                <th class="nowrap" th:if="*{optionTemplate == 'CUSTOM'}">スコア</th>
                <th class="nowrap" th:if="*{questionRole == 'ATTENTION_CHECK'}">期待する回答</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="opt, stat : *{options}">
                <td class="nowrap" th:text="${stat.index + 1}"></td>

                <td>
                  <input class="input" type="text" th:field="*{options[__${stat.index}__].optionText}">
                </td>

                <td th:if="*{optionTemplate == 'CUSTOM'}" class="nowrap">
                  <input class="input" type="number" th:field="*{options[__${stat.index}__].score}" style="max-width: 8em;">
                </td>

                <td th:if="*{questionRole == 'ATTENTION_CHECK'}" class="nowrap">
                  <input type="checkbox" th:field="*{options[__${stat.index}__].correct}">
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <p class="muted" th:if="*{optionTemplate != 'CUSTOM'}">
          ※テンプレ選択時は、スコアは自動で 1..N が入る想定です（保存時にサーバ側で設定）。
        </p>

        <p class="muted">※表示順は自動で末尾に追加されます。</p>
      </div>

      <div class="actions">
        <button class="btn btn-primary" type="submit">登録</button>
      </div>
    </form>
  </div>
</body>
</html>

